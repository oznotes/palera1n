name: Build palera1n for Linux x86

on:
  push:
    paths:
      - 'src/**'
      - 'include/**'
      - 'Makefile'
      - '.github/workflows/build-linux-x86.yml'
  pull_request:
    paths:
      - 'src/**'
      - 'include/**'
      - 'Makefile'
      - '.github/workflows/build-linux-x86.yml'
  workflow_dispatch:

jobs:
  build-Linux:
    runs-on: ubuntu-latest
    env:
      MBEDTLS_VERSION: 3.5.2
      LIBUSB_VERSION: 1.0.27
      READLINE_VERSION: 8.2
      GPM_VERSION: 1.20.7
      LIBIMOBILEDEVICE_COMMIT: ed0d66d0341562731bb19928dfe48155509fa7a7
      LIBIRECOVERY_COMMIT: 7ce02c347b7c26e59498e6af31c9da51018d0fa1
      LIBIMOBILEDEVICE_GLUE_COMMIT: 362f7848ac89b74d9dd113b38b51ecb601f76094
      USBMUXD_COMMIT: bc0b91ca856811f4393318dc83db6dc3c1ac326d
      LIBPLIST_COMMIT: 2117b8fdb6b4096455bd2041a63e59a028120136
      LIBUSBMUXD_COMMIT: a7f0543fb1ecb20ac7121c0fd77297200e0e43fc

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get remove -y libssl-dev libreadline-dev
          sudo apt-get install -y pkg-config autoconf automake autopoint mandoc cmake
          sudo pip3 install jsonschema jinja2

      - name: Download toolchain
        run: |
          curl -LO https://musl.cc/i486-linux-musl-cross.tgz
          tar -xf i486-linux-musl-cross.tgz

      - name: Setup environment
        run: |
          echo "$(pwd)/i486-linux-musl-cross/bin" >> $GITHUB_PATH
          echo "PKG_CONFIG_PATH=$(pwd)/sysroot/usr/local/lib/pkgconfig" >> $GITHUB_ENV
          echo "CFLAGS=-g -fdata-sections -ffunction-sections -I$(pwd)/sysroot/usr/local/include -L$(pwd)/sysroot/usr/local/lib -D_FILE_OFFSET_BITS=64 -D_TIME_BITS=64" >> $GITHUB_ENV
          echo "CXXFLAGS=-g -fdata-sections -ffunction-sections -I$(pwd)/sysroot/usr/local/include -L$(pwd)/sysroot/usr/local/lib -D_FILE_OFFSET_BITS=64 -D_TIME_BITS=64" >> $GITHUB_ENV
          echo "LDFLAGS=-g -Wl,--gc-sections -fdata-sections -ffunction-sections -I$(pwd)/sysroot/usr/local/include -L$(pwd)/sysroot/usr/local/lib" >> $GITHUB_ENV
          echo "DESTDIR=$(pwd)/sysroot" >> $GITHUB_ENV
          echo "PREFIX=/usr/local" >> $GITHUB_ENV
          echo "CONFIGURE_ARGS=--build=x86_64-linux-gnu --host=i486-linux-musl --prefix=/usr/local --disable-shared --enable-static" >> $GITHUB_ENV
          echo "CROSS_COMPILE=i486-linux-musl-" >> $GITHUB_ENV

      - name: Download dependencies
        run: |
          curl -LO https://github.com/Mbed-TLS/mbedtls/archive/refs/tags/v${{ env.MBEDTLS_VERSION }}.tar.gz
          curl -LO https://github.com/libusb/libusb/releases/download/v${{ env.LIBUSB_VERSION }}/libusb-${{ env.LIBUSB_VERSION }}.tar.bz2
          curl -LO https://mirror-hk.koddos.net/gnu/readline/readline-${{ env.READLINE_VERSION }}.tar.gz
          curl -LO https://github.com/telmich/gpm/archive/refs/tags/${{ env.GPM_VERSION }}.tar.gz
          tar -xf v${{ env.MBEDTLS_VERSION }}.tar.gz
          tar -xjf libusb-${{ env.LIBUSB_VERSION }}.tar.bz2
          tar -xf readline-${{ env.READLINE_VERSION }}.tar.gz
          tar -xf ${{ env.GPM_VERSION }}.tar.gz
          git clone --depth=1 https://github.com/libimobiledevice/libplist
          git clone --depth=1 https://github.com/libimobiledevice/libimobiledevice-glue
          git clone --depth=1 https://github.com/libimobiledevice/libirecovery
          git clone --depth=1 https://github.com/libimobiledevice/libusbmuxd
          git clone --depth=1 https://github.com/libimobiledevice/libimobiledevice
          git clone --depth=1 https://github.com/libimobiledevice/usbmuxd
          git clone --depth=1 https://github.com/fxsheep/libtatsu



      - name: Create CMake toolchain file
        run: |
          cat << EOF > i486-linux-musl-toolchain.cmake
          set(CMAKE_SYSTEM_NAME Linux)
          set(CMAKE_SYSTEM_PROCESSOR i486)

          set(CMAKE_C_COMPILER i486-linux-musl-gcc)
          set(CMAKE_CXX_COMPILER i486-linux-musl-g++)

          set(CMAKE_FIND_ROOT_PATH ${{ env.DESTDIR }}${{ env.PREFIX }})
          set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
          set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
          set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)

          set(CMAKE_C_FLAGS "${CFLAGS}")
          set(CMAKE_CXX_FLAGS "${CXXFLAGS}")
          EOF

      - name: Build Mbed TLS
        run: |
          cd mbedtls-${{ env.MBEDTLS_VERSION }}
          sed -i 's/#define MBEDTLS_AESNI_C/\/\/ #define MBEDTLS_AESNI_C/' include/mbedtls/mbedtls_config.h
          mkdir build && cd build
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=../../i486-linux-musl-toolchain.cmake \
            -DCMAKE_INSTALL_PREFIX=${{ env.PREFIX }} \
            -DENABLE_PROGRAMS=OFF \
            -DENABLE_TESTING=OFF \
            -DCMAKE_BUILD_TYPE=Release \
            -DMBEDTLS_HAVE_SSE2=OFF \
            -DMBEDTLS_HAVE_X86_64=OFF \
            -DCMAKE_C_FLAGS="${CFLAGS} -march=i486 -mtune=i486"
          make -j$(nproc)
          make install DESTDIR=${{ env.DESTDIR }}
          cd ../..

      - name: Build libusb
        run: |
          cd libusb-${{ env.LIBUSB_VERSION }}
          ./configure ${{ env.CONFIGURE_ARGS }} --disable-udev
          make -j$(nproc)
          make install DESTDIR=${{ env.DESTDIR }}
          mkdir -p ${{ env.DESTDIR }}/usr/local/lib
          # Copy the .la file from the correct location
          cp libusb/.libs/libusb-1.0.la ${{ env.DESTDIR }}/usr/local/lib/
          cd ..

      - name: Verify libusb .la file
        run: |
          ls -l ${{ env.DESTDIR }}/usr/local/lib/libusb-1.0.la
          if [ ! -f "${{ env.DESTDIR }}/usr/local/lib/libusb-1.0.la" ]; then
            echo "libusb-1.0.la not found!"
            exit 1
          fi

      - name: Build readline
        run: |
          cd readline-${{ env.READLINE_VERSION }}
          ./configure ${{ env.CONFIGURE_ARGS }}
          make -j$(nproc)
          make install DESTDIR=${{ env.DESTDIR }}
          cd ..

      - name: Build libplist
        run: |
          cd libplist
          ./autogen.sh
          ./configure ${{ env.CONFIGURE_ARGS }} --without-cython --enable-static --disable-shared
          make -j$(nproc)
          make install DESTDIR=${{ env.DESTDIR }}
          mkdir -p ${{ env.DESTDIR }}/usr/local/lib
          # Copy the .la files from the correct locations
          cp src/.libs/libplist-2.0.la ${{ env.DESTDIR }}/usr/local/lib/
          cp src/.libs/libplist++-2.0.la ${{ env.DESTDIR }}/usr/local/lib/
          cd ..
      - name: Verify libplist .la files
        run: |
          ls -l ${{ env.DESTDIR }}/usr/local/lib/libplist-2.0.la
          ls -l ${{ env.DESTDIR }}/usr/local/lib/libplist++-2.0.la
          if [ ! -f "${{ env.DESTDIR }}/usr/local/lib/libplist-2.0.la" ] || [ ! -f "${{ env.DESTDIR }}/usr/local/lib/libplist++-2.0.la" ]; then
            echo "libplist .la files not found!"
            exit 1
          fi
      - name: Build libimobiledevice-glue
        run: |
          cd libimobiledevice-glue
          ./autogen.sh
          ./configure ${{ env.CONFIGURE_ARGS }} --enable-static --disable-shared
          make -j$(nproc)
          make install DESTDIR=${{ env.DESTDIR }}
          mkdir -p ${{ env.DESTDIR }}/usr/local/lib
          # Copy the .la file from the correct location
          cp src/.libs/libimobiledevice-glue-1.0.la ${{ env.DESTDIR }}/usr/local/lib/
          cd ..

      - name: Verify libimobiledevice-glue .la file
        run: |
          ls -l ${{ env.DESTDIR }}/usr/local/lib/libimobiledevice-glue-1.0.la
          if [ ! -f "${{ env.DESTDIR }}/usr/local/lib/libimobiledevice-glue-1.0.la" ]; then
            echo "libimobiledevice-glue-1.0.la not found!"
            exit 1
          fi

      - name: Build libusbmuxd
        run: |
          cd libusbmuxd
          ./autogen.sh
          ./configure ${{ env.CONFIGURE_ARGS }} --enable-static --disable-shared
          make -j$(nproc)
          make install DESTDIR=${{ env.DESTDIR }}
          mkdir -p ${{ env.DESTDIR }}/usr/local/lib
          # Copy the .la file from the correct location
          cp src/.libs/libusbmuxd-2.0.la ${{ env.DESTDIR }}/usr/local/lib/
          cd ..

      - name: Verify libusbmuxd .la file
        run: |
          ls -l ${{ env.DESTDIR }}/usr/local/lib/libusbmuxd-2.0.la
          if [ ! -f "${{ env.DESTDIR }}/usr/local/lib/libusbmuxd-2.0.la" ]; then
            echo "libusbmuxd-2.0.la not found!"
            exit 1
          fi
      - name: Build libtatsu
        run: |
          cd libtatsu
          ./autogen.sh
          ./configure ${{ env.CONFIGURE_ARGS }} --enable-static --disable-shared
          make -j$(nproc)
          make install DESTDIR=${{ env.DESTDIR }}
          mkdir -p ${{ env.DESTDIR }}/usr/local/lib
          # Copy the .la file from the correct location (adjust if necessary)
          cp src/.libs/libtatsu-1.0.la ${{ env.DESTDIR }}/usr/local/lib/
          cd ..

      - name: Verify libtatsu .la file
        run: |
          ls -l ${{ env.DESTDIR }}/usr/local/lib/libtatsu-1.0.la
          if [ ! -f "${{ env.DESTDIR }}/usr/local/lib/libtatsu-1.0.la" ]; then
            echo "libtatsu-1.0.la not found!"
            exit 1
          fi

      - name: Build libimobiledevice
        run: |
          cd libimobiledevice
          export PKG_CONFIG_PATH=${{ env.DESTDIR }}${{ env.PREFIX }}/lib/pkgconfig:$PKG_CONFIG_PATH
          ./autogen.sh
          ./configure ${{ env.CONFIGURE_ARGS }} --with-mbedtls --enable-static --disable-shared
          make -j$(nproc)
          make install DESTDIR=${{ env.DESTDIR }}
          mkdir -p ${{ env.DESTDIR }}/usr/local/lib
          # Copy the .la file from the correct location
          cp src/.libs/libimobiledevice-1.0.la ${{ env.DESTDIR }}/usr/local/lib/
          cd ..

      - name: Verify libimobiledevice .la file
        run: |
          ls -l ${{ env.DESTDIR }}/usr/local/lib/libimobiledevice-1.0.la
          if [ ! -f "${{ env.DESTDIR }}/usr/local/lib/libimobiledevice-1.0.la" ]; then
            echo "libimobiledevice-1.0.la not found!"
            exit 1
          fi

      - name: Build libirecovery
        run: |
          cd libirecovery
          export PKG_CONFIG_PATH=${{ env.DESTDIR }}${{ env.PREFIX }}/lib/pkgconfig:$PKG_CONFIG_PATH
          export CFLAGS="$CFLAGS -I${{ env.DESTDIR }}${{ env.PREFIX }}/include/libusb-1.0 -I${{ env.DESTDIR }}${{ env.PREFIX }}/include"
          export LDFLAGS="$LDFLAGS -L${{ env.DESTDIR }}${{ env.PREFIX }}/lib"
          export LIBPLIST_LIBS="-L${{ env.DESTDIR }}${{ env.PREFIX }}/lib -lplist-2.0"
          export LIBPLIST_CFLAGS="-I${{ env.DESTDIR }}${{ env.PREFIX }}/include"
          export LIBIMOBILEDEVICE_GLUE_LIBS="-L${{ env.DESTDIR }}${{ env.PREFIX }}/lib -limobiledevice-glue-1.0"
          export LIBIMOBILEDEVICE_GLUE_CFLAGS="-I${{ env.DESTDIR }}${{ env.PREFIX }}/include"
          export LIBUSB_LIBS="-L${{ env.DESTDIR }}${{ env.PREFIX }}/lib -lusb-1.0"
          export LIBUSB_CFLAGS="-I${{ env.DESTDIR }}${{ env.PREFIX }}/include/libusb-1.0"
          ./autogen.sh
          ./configure ${{ env.CONFIGURE_ARGS }} --enable-static --disable-shared
          make -j$(nproc)
          make install DESTDIR=${{ env.DESTDIR }}
          cd ..

      - name: Build palera1n
        run: |
          # Check if sysroot directories exist
          if [ ! -d "${{ env.DESTDIR }}${{ env.PREFIX }}/include" ] || [ ! -d "${{ env.DESTDIR }}${{ env.PREFIX }}/lib" ]; then
            echo "Error: Sysroot directories don't exist. Dependencies may not have been built correctly."
            exit 1
          fi

          # Create dep_root directory
          mkdir -p dep_root

          # Copy include and lib directories
          cp -a ${{ env.DESTDIR }}${{ env.PREFIX }}/{include,lib} dep_root

          # Remove unnecessary files
          find dep_root -name '*.so' -delete
          find dep_root -name '*.la' -delete

          # Build palera1n
          CC="${{ env.CROSS_COMPILE }}gcc" make -j$(nproc) ROOTFUL=1

          # Copy the built binary
          cp src/palera1n palera1n-linux-x86

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: palera1n-linux-x86
          path: palera1n-linux-x86